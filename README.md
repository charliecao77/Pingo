太棒了！既然测试已经通过，这意味着核心逻辑（包括 iOS 17 的兼容性修复以及可选值的安全解包）已经稳定。

为了确保项目的长期维护以及未来 AI 开发的效率，我为你整理了更新后的**需求文档**、**开发文档**以及**AI 提示词（Prompt）**。

---

## 1. 需求文档 (Requirements Document) - v3.1

### 项目背景

Pingo 是一款专为家庭设计的安全报备工具，通过简单的“一键打卡”机制，让家长实时掌握子女的平安状态。

### 核心功能

* **双端角色切换**：同一 App 支持“家长”和“学生”角色。
* **智能倒计时**：
* **学生端**：显示距离下一次打卡的剩余时间。
* **家长端**：实时列出所有家庭成员的报备状态及超时预警。


* **全方位告警系统**：
* **本地通知**：学生端在打卡前 N 分钟提醒；家长端在学生超时后立即通过系统告警。
* **邮件预警**：后端自动检测，若超时则通过 Brevo API 向家长发送紧急邮件。


* **安全重置机制**：家长可通过绑定的邮箱接收 6 位验证码，重置管理密码。

### 技术约束

* **系统要求**：兼容 iOS 17+ 语法标准（如 `onChange` 的新语法）。
* **数据安全**：所有配置和状态存储于 Cloudflare KV 数据库，通过 `familyEmail` 隔离家庭数据。

---

## 2. 开发文档 (Developer Guide) - v3.1

### 后端架构 (Cloudflare Worker)

* **存储结构**：
* `FAMILY#email`：存储家庭成员列表和管理密码。
* `CONFIG#email#name`：存储个人打卡间隔和提醒时间。
* `STATUS#email#name`：存储最后一次打卡的 Unix 时间戳。


* **关键逻辑**：
* 在 `status` 接口请求时，后端会自动计算 `isOverdue`。若超时且未标记 `ALARM_SENT`，则触发 Brevo 邮件发送流程。



### 前端架构 (SwiftUI)

* **状态驱动**：使用 `@AppStorage` 持久化本地偏好，通过 `Combine` 的定时器每 10 秒与后端同步一次。
* **本地通知修复**：
* **修复点**：由于后端返回的配置均为 `String?`，在计算通知触发时间时，必须进行 `(Double(config.interval ?? "24") ?? 24.0)` 的嵌套解包，防止数学运算引发崩溃。


* **生命周期管理**：利用 `scenePhase` 在 App 切回前台时强制刷新数据。

---

## 3. AI 辅助开发提示词 (AI Prompt)

当你未来需要基于此代码进行功能扩展（例如：增加地理位置、增加多家长支持）时，请使用以下提示词来约束 AI：

> **Role**: 你是一个精通 SwiftUI (iOS 17+) 和 Cloudflare Workers 的资深开发者。
> **Context**: Pingo 是一款家庭报备工具。后端使用 Cloudflare KV，前端使用 SwiftUI。
> **Coding Standards (CRITICAL)**:
> 1. **全量输出**: 任何代码修改必须输出该文件的**完整代码**，禁止使用 `...` 或折叠未修改的部分。
> 2. **类型安全**: 后端 KV 返回的数值通常为 String。在 Swift 中处理时，必须进行安全解包，例如：`Double(value ?? "default") ?? 0.0`，禁止直接对 Optional 使用运算符。
> 3. **版本兼容**: 必须使用 iOS 17+ 标准，例如 `onChange(of:oldValue:newValue)`。
> 4. **结构对齐**: 保持已有的 `Section` 结构和 `@AppStorage` 变量名不变，确保直接复制后即可运行。
> 
> 
> **Task**: [在此输入你的新需求，例如：请在设置页面增加一个“手动重置所有本地缓存”的按钮]

